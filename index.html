<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Conference</title>
</head>
<body>
<h2>Local Video</h2>
<video id="localVideo" autoplay playsinline></video>
<h2>Remote Videos</h2>
<div id="remoteVideos"></div>

<script>
    const roomId = "test-room";
    const userId = Math.random().toString(36).substr(2, 9);
    const ws = new WebSocket(`wss://193.29.225.92/ws/${roomId}/${userId}`);

    const peerConnections = {};
    const remoteVideos = document.getElementById("remoteVideos");

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ –∏ –∞—É–¥–∏–æ
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
            document.getElementById("localVideo").srcObject = stream;
            ws.onopen = () => {
                ws.send(JSON.stringify({ type: "join", userId }));
            };
        });

    ws.onmessage = async event => {
        const data = JSON.parse(event.data);

        if (data.type === "new-user" && data.userId !== userId) {
            createPeerConnection(data.userId, true);
        } else if (data.type === "offer" && data.to === userId) {
            await handleOffer(data.offer, data.from);
        } else if (data.type === "answer" && data.to === userId) {
            await handleAnswer(data.answer, data.from);
        } else if (data.type === "candidate" && data.to === userId) {
            await handleCandidate(data.candidate, data.from);
        }
    };

    function createPeerConnection(remoteUserId, initiator = false) {
        if (peerConnections[remoteUserId]) {
            console.warn(`–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${remoteUserId} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
            return;
        }

        const peerConnection = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });

        // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –≤—Å–µ–≥–¥–∞, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞!
        const localStream = document.getElementById("localVideo").srcObject;
        if (localStream) {
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        } else {
            console.warn("–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!");
        }

        peerConnection.ontrack = event => {
            console.log(`üî• –ü–æ–ª—É—á–µ–Ω –ø–æ—Ç–æ–∫ –æ—Ç ${remoteUserId}, —Ç—Ä–µ–∫–æ–≤: ${event.streams[0].getTracks().length}`);

            let video = document.getElementById(`video-${remoteUserId}`);
            if (!video) {
                video = document.createElement("video");
                video.id = `video-${remoteUserId}`;
                video.autoplay = true;
                video.playsInline = true;
                remoteVideos.appendChild(video);
            }

            video.srcObject = event.streams[0];
            setTimeout(() => {
                video.play()
                    .then(() => console.log("üé¨ –í–∏–¥–µ–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è!"))
                    .catch(err => console.error("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ play():", err));
            }, 500);
            console.log("üì∫ –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–µ–æ:", video);
            console.log("üé• –í–∏–¥–µ–æ srcObject:", video.srcObject);

            setTimeout(() => {
                if (video.readyState === 0) {
                    console.error("üö® –í–∏–¥–µ–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–∑–≤–∞—Ç—å play() –≤—Ä—É—á–Ω—É—é.");
                    video.play().catch(err => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ play():", err));
                }
            }, 2000);
            console.log("üé• –í–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç:", video, "–ü–æ—Ç–æ–∫:", video.srcObject);
        };

        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                ws.send(JSON.stringify({ type: "candidate", candidate: event.candidate, from: userId, to: remoteUserId }));
            }
        };

        peerConnections[remoteUserId] = peerConnection;

        if (initiator) {
            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => {
                    ws.send(JSON.stringify({ type: "offer", offer: peerConnection.localDescription, to: remoteUserId, from: userId }));
                })
                .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:", error));
        }
    }


    async function handleOffer(offer, from) {
        if (!peerConnections[from]) {
            createPeerConnection(from, false);
        }

        const peerConnection = peerConnections[from];

        console.log(`Setting remote description for offer from ${from}`);
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnection.createAnswer();
        console.log(`Setting local description for answer to ${from}`);
        await peerConnection.setLocalDescription(answer);

        ws.send(JSON.stringify({ type: "answer", answer: answer, to: from, from: userId }));
    }

    async function handleAnswer(answer, from) {
        const peerConnection = peerConnections[from];
        if (!peerConnection) {
            console.error(`–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ ${from}`);
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –æ—Ç–≤–µ—Ç–∞
        if (peerConnection.signalingState !== "have-remote-offer") {
            console.warn(`–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º answer –æ—Ç ${from}, —Ç–∞–∫ –∫–∞–∫ signalingState —É–∂–µ ${peerConnection.signalingState}`);
            return;
        }

        console.log(`–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç ${from}`);
        try {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            console.log("–£–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.");
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è:", error);
        }
    }


    async function handleCandidate(candidate, from) {
        const peerConnection = peerConnections[from];
        if (!peerConnection) {
            console.error(`No peer connection found for ${from}`);
            return;
        }

        console.log(`Adding ICE candidate from ${from}`);
        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
    }

</script>
</body>
</html>